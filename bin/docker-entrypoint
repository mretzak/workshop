#!/bin/bash -e

# Workshop-specific database setup with automatic migration and seeding
if [ "${1}" == "./bin/rails" ] && [ "${2}" == "server" ]; then
  echo "ğŸš€ Starting N+1 Workshop application..."
  echo "ğŸ“Š Setting up database (Host: ${DATABASE_HOST:-localhost}, User: ${DATABASE_USERNAME:-workshop}, DB: workshop_development)..."

  echo "â³ Waiting for Rails to connect to database..."
  retry_count=0
  max_retries=30 # Wait for up to 60 seconds (30 * 2s)
  until ./bin/rails runner "ActiveRecord::Base.connection.execute('SELECT 1')" > /dev/null 2>&1; do
    retry_count=$((retry_count + 1))
    if [ "$retry_count" -gt "$max_retries" ]; then
      echo "âŒ Failed to connect to database via Rails after $max_retries attempts. Dumping last connection attempt error:"
      # Attempt one last time, showing errors to stdout/stderr
      ./bin/rails runner "begin; ActiveRecord::Base.connection.execute('SELECT 1'); rescue => e; STDERR.puts \"Connection error: #{e.class} - #{e.message}\"; exit 1; end"
      exit 1 # Exit if the verbose attempt also fails or if it succeeds (shouldn't happen here)
    fi
    echo "Database not ready for Rails (attempt $retry_count/$max_retries), waiting 2s..."
    sleep 2
  done
  echo "âœ… Rails connected to database!"

  echo "ğŸ” Checking if database schema (tables) exists..."
  # Capture the output from the Rails runner script
  # This script will print specific strings based on the state
  setup_needed_output=$(RAILS_ENV=development ./bin/rails runner "
    begin
      User.count # Attempt to count users
      puts 'SETUP_NOT_NEEDED'
    rescue ActiveRecord::StatementInvalid, PG::UndefinedTable # Common errors if tables don't exist
      puts 'NEEDS_SETUP_TABLES_MISSING'
    rescue PG::ConnectionBad => e # Specific connection errors
      puts \"NEEDS_SETUP_CONNECTION_BAD: #{e.message.split('\\n').first}\"
    rescue => e # Other errors
      puts \"NEEDS_SETUP_OTHER_ERROR: #{e.class} - #{e.message.split('\\n').first}\"
    end
  ")

  echo "ğŸ”¬ DB Check Output: ${setup_needed_output}"

  if [[ "${setup_needed_output}" == "SETUP_NOT_NEEDED" ]]; then
    echo "ğŸ“‹ Database schema already exists. Checking for pending migrations..."
    RAILS_ENV=development ./bin/rails db:migrate
    if [ $? -ne 0 ]; then
      echo "âŒ Database migration failed during routine check!"
      exit 1
    fi
    echo "âœ… Database migrations checked. Ready for workshop!"
  elif [[ "${setup_needed_output}" == NEEDS_SETUP* ]]; then # Catches all NEEDS_SETUP variants
    echo "ğŸ”§ Database needs setup. Reason: ${setup_needed_output}"

    echo "âš™ï¸ Running database migrations..."
    RAILS_ENV=development ./bin/rails db:migrate
    if [ $? -ne 0 ]; then
      echo "âŒ Database migration failed!"
      exit 1
    fi

    echo "ğŸŒ± Seeding workshop data..."
    RAILS_ENV=development ./bin/rails db:seed
    if [ $? -ne 0 ]; then
      echo "âŒ Database seeding failed!"
      exit 1
    fi
    echo "âœ¨ Workshop database setup complete!"
  else
    echo "ğŸ¤· Unknown database state from check: '${setup_needed_output}'. Exiting."
    exit 1
  fi

  echo ""
  echo "ğŸ¯ Workshop endpoints ready:"
  echo "   ğŸ“ Rails API (N+1 example): http://localhost:3000/posts/n_plus_one"
  echo "   ğŸš€ Rails API (Optimized):   http://localhost:3000/posts/optimized"
  echo "   ğŸ” GraphQL Endpoint:        http://localhost:3000/graphql"
  echo "   ğŸ¨ GraphiQL UI:             http://localhost:3000/graphiql"
  echo ""
fi

exec "${@}"
